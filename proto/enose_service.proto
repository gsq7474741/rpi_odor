// 电子鼻 gRPC 服务定义
// 提供控制接口和数据流服务

syntax = "proto3";

package enose.service;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "enose_data.proto";
import "enose_config.proto";

option go_package = "enose/service";

// ============================================================
// 控制服务 (ControlService)
// 用于接收外部控制命令
// ============================================================
service ControlService {
  // 获取系统状态
  rpc GetStatus(google.protobuf.Empty) returns (SystemStatus);
  
  // 切换系统状态
  rpc SetSystemState(SetSystemStateRequest) returns (SetSystemStateResponse);
  
  // 手动控制单个外设
  rpc ManualControl(ManualControlRequest) returns (ManualControlResponse);
  
  // 启动泵 (步进泵需要指定参数)
  rpc RunPump(RunPumpRequest) returns (RunPumpResponse);
  
  // 停止所有泵
  rpc StopAllPumps(google.protobuf.Empty) returns (StopAllPumpsResponse);
  
  // 开始进样 (设置阀门 + 启动指定蠕动泵) - 单位: mm
  rpc StartInjection(StartInjectionRequest) returns (StartInjectionResponse);
  
  // 开始进样 (按重量) - 单位: g (真实重量)
  // 内部转换: x = (y - weight_offset) / weight_scale, mm = x / pump_mm_to_ml
  rpc StartInjectionByWeight(StartInjectionByWeightRequest) returns (StartInjectionResponse);
  
  // 停止进样
  rpc StopInjection(google.protobuf.Empty) returns (StopInjectionResponse);
  
  // 紧急停止 (发送 M112 急停命令，会触发 Klipper shutdown，需要 FIRMWARE_RESTART 恢复)
  rpc EmergencyStop(google.protobuf.Empty) returns (EmergencyStopResponse);
  
  // 重启固件 (急停后恢复)
  rpc FirmwareRestart(google.protobuf.Empty) returns (FirmwareRestartResponse);
  
  // 订阅系统事件流
  rpc SubscribeEvents(google.protobuf.Empty) returns (stream enose.data.Event);
  
  // 订阅外设状态更新
  rpc SubscribePeripheralStatus(google.protobuf.Empty) returns (stream PeripheralStatus);
}

// ============================================================
// 数据服务 (DataService)
// 用于传感器数据流
// ============================================================
service DataService {
  // 订阅传感器数据流
  rpc SubscribeSensorData(google.protobuf.Empty) returns (stream enose.data.SensorFrame);
  
  // 订阅分析结果流
  rpc SubscribeAnalysisResults(google.protobuf.Empty) returns (stream enose.data.AnalysisResult);
}

// ============================================================
// 传感器控制服务 (SensorService)
// 用于控制 BME688 传感器板
// ============================================================
service SensorService {
  // 发送传感器命令 (sync, init, start, stop, status, reset, config)
  rpc SendCommand(SensorCommandRequest) returns (SensorCommandResponse);
  
  // 订阅传感器数据流 (实时推送)
  rpc SubscribeSensorReadings(google.protobuf.Empty) returns (stream SensorReading);
  
  // 获取传感器板状态
  rpc GetSensorStatus(google.protobuf.Empty) returns (SensorBoardStatus);
  
  // 配置加热器
  rpc ConfigureHeater(HeaterConfigRequest) returns (HeaterConfigResponse);
}

// ============================================================
// 请求/响应消息定义
// ============================================================

// 系统状态枚举
enum SystemStateEnum {
  SYSTEM_STATE_UNSPECIFIED = 0;
  INITIAL = 1;        // 开机初始状态
  DRAIN = 2;          // 排废状态
  CLEAN = 3;          // 清洗状态: 出气阀开, 气体三通阀指向大气, 清洗泵开, 夹管阀液路, 排废阀关
  SAMPLE = 4;         // 采样状态: 排废关, 夹管阀气路, 出气阀开, 三通阀指向气室, 气泵开
  INJECT = 5;         // 进样状态: 阀门同CLEAN, 使用蠕动泵进样
}

// 系统状态响应
message SystemStatus {
  // 当前系统状态
  SystemStateEnum current_state = 1;
  
  // 所有外设的当前状态
  PeripheralStatus peripheral_status = 2;
  
  // 系统运行时间 (秒)
  uint64 uptime_seconds = 3;
  
  // 连接状态
  bool moonraker_connected = 4;
  bool sensor_connected = 5;
  bool firmware_ready = 7;  // Klipper 固件是否就绪 (急停后为 false)
  
  // 最后更新时间
  google.protobuf.Timestamp last_updated = 6;
}

// 外设状态
message PeripheralStatus {
  // 阀门状态
  float valve_waste = 1;      // 0: 关闭, 1: 开启
  float valve_pinch = 2;      // 0: 气路, 1: 液路
  float valve_air = 3;        // 0: 排气, 1: 气室
  float valve_outlet = 4;     // 0: 开启, 1: 关闭 (反向逻辑)
  
  // 泵状态
  float air_pump_pwm = 5;     // 0.0 - 1.0
  float cleaning_pump = 6;    // 0.0 - 1.0
  PumpRunState pump_2 = 7;    // 样品泵 0
  PumpRunState pump_3 = 8;    // 样品泵 1
  PumpRunState pump_4 = 9;    // 样品泵 2
  PumpRunState pump_5 = 10;   // 样品泵 3
  
  // 加热器状态
  float heater_chamber = 11;  // 0.0 - 1.0
  
  // 传感器读数 (只读)
  optional float sensor_chamber_temp = 20;  // 气室温度 (°C)
  optional float scale_weight = 21;         // 称重值 (g)
  
  enum PumpRunState {
    PUMP_RUN_STATE_UNSPECIFIED = 0;
    STOPPED = 1;
    RUNNING = 2;
  }
}

// 设置系统状态请求
message SetSystemStateRequest {
  SystemStateEnum target_state = 1;
}

message SetSystemStateResponse {
  bool success = 1;
  string message = 2;
  SystemStateEnum new_state = 3;
}

// 手动控制请求
message ManualControlRequest {
  // 外设名称 (valve_waste, valve_pinch, air_pump_pwm, etc.)
  string peripheral_name = 1;
  
  // 目标值 (对于开关类型: 0/1, 对于PWM: 0.0-1.0)
  float value = 2;
}

message ManualControlResponse {
  bool success = 1;
  string message = 2;
}

// 进样请求
message StartInjectionRequest {
  // 每个蠕动泵的进样量 (单位待标定，目前为步进电机移动距离 mm)
  float pump_2_volume = 1;  // 蠕动泵0
  float pump_3_volume = 2;  // 蠕动泵1
  float pump_4_volume = 3;  // 蠕动泵2
  float pump_5_volume = 4;  // 蠕动泵3
  
  // 可选参数
  optional float speed = 5;  // 进样速度 (mm/s), 默认 10
  optional float accel = 6;  // 加速度 (mm/s²), 默认 100
}

message StartInjectionResponse {
  bool success = 1;
  string message = 2;
}

// 按重量进样请求 (单位: g 真实重量)
// 后端转换: x = (y - weight_offset) / weight_scale, mm = x / pump_mm_to_ml
message StartInjectionByWeightRequest {
  // 每个蠕动泵的进样量 (单位: g 真实重量)
  float pump_2_weight = 1;  // 蠕动泵0
  float pump_3_weight = 2;  // 蠕动泵1
  float pump_4_weight = 3;  // 蠕动泵2
  float pump_5_weight = 4;  // 蠕动泵3
  
  // 可选参数
  optional float speed = 5;  // 进样速度 (mm/s), 默认 10
  optional float accel = 6;  // 加速度 (mm/s²), 默认 100
}

message StopInjectionResponse {
  bool success = 1;
  string message = 2;
}

// 紧急停止响应
message EmergencyStopResponse {
  bool success = 1;
  string message = 2;
}

// 固件重启响应
message FirmwareRestartResponse {
  bool success = 1;
  string message = 2;
}

// 运行泵请求
message RunPumpRequest {
  // 泵名称 (pump_2, pump_3, pump_4, pump_5, cleaning_pump)
  string pump_name = 1;
  
  // 速度 (步进泵: mm/s, DC泵: 0.0-1.0 PWM)
  float speed = 2;
  
  // 距离 (仅步进泵需要, 单位: mm)
  optional float distance = 3;
  
  // 加速度 (仅步进泵需要, 单位: mm/s²)
  optional float accel = 4;
}

message RunPumpResponse {
  bool success = 1;
  string message = 2;
}

message StopAllPumpsResponse {
  bool success = 1;
  string message = 2;
}

// ============================================================
// 传感器服务消息定义
// ============================================================

// 传感器命令请求
message SensorCommandRequest {
  // 命令类型: sync, init, start, stop, status, reset
  string command = 1;
  
  // 可选参数 (JSON 格式字符串)
  optional string params_json = 2;
}

message SensorCommandResponse {
  bool success = 1;
  string message = 2;
  
  // 响应数据 (JSON 格式字符串)
  optional string data_json = 3;
}

// 传感器板状态
message SensorBoardStatus {
  bool connected = 1;
  bool running = 2;           // 是否正在采集
  uint32 sensor_count = 3;    // 传感器数量
  string firmware_version = 4;
  string port = 5;
}

// 单个传感器读数 (实时数据流)
message SensorReading {
  uint64 tick_ms = 1;         // 设备时间戳 (毫秒)
  uint32 sensor_idx = 2;      // 传感器索引 (0-7)
  uint32 sensor_id = 3;       // 传感器 ID
  double value = 4;           // 主读数 (电阻/电压)
  string sensor_type = 5;     // mox_d, mox_a, pid
  
  optional double temperature = 6;
  optional double humidity = 7;
  optional double pressure = 8;
  
  uint32 heater_step = 9;     // 加热器步进索引
  uint32 adc_channel = 10;
}

// 加热器配置请求
message HeaterConfigRequest {
  repeated uint32 temps = 1;  // 温度列表 (°C)
  repeated uint32 durs = 2;   // 持续时间列表 (×140ms)
  
  // 目标传感器 (空=所有)
  repeated uint32 sensors = 3;
}

message HeaterConfigResponse {
  bool success = 1;
  string message = 2;
}

// 加热器预设
message HeaterPreset {
  string name = 1;
  string description = 2;
  repeated uint32 temps = 3;
  repeated uint32 durs = 4;
}

// ============================================================
// 称重服务 (LoadCellService)
// 用于称重传感器标定和读取
// ============================================================
service LoadCellService {
  // === 标定相关 ===
  // 开始标定向导
  rpc StartCalibration(google.protobuf.Empty) returns (CalibrationStatus);
  
  // 设置零点 (空载时调用)
  rpc SetZeroPoint(google.protobuf.Empty) returns (CalibrationStatus);
  
  // 设置参考重量 (放置已知重量物体后调用)
  rpc SetReferenceWeight(ReferenceWeightRequest) returns (CalibrationStatus);
  
  // 保存标定结果
  rpc SaveCalibration(google.protobuf.Empty) returns (CalibrationResult);
  
  // 取消标定
  rpc CancelCalibration(google.protobuf.Empty) returns (google.protobuf.Empty);
  
  // === 业务配置 ===
  // 等待空瓶稳定 (动态跟踪空瓶值)
  rpc WaitForEmptyBottle(WaitForEmptyBottleRequest) returns (WaitForEmptyBottleResponse);
  
  // 重置动态空瓶值
  rpc ResetDynamicEmptyWeight(google.protobuf.Empty) returns (google.protobuf.Empty);
  
  // 获取当前动态空瓶值
  rpc GetDynamicEmptyWeight(google.protobuf.Empty) returns (DynamicEmptyWeightResponse);
  
  // 设置溢出阈值
  rpc SetOverflowThreshold(ThresholdRequest) returns (google.protobuf.Empty);
  
  // 设置泵校准系数 (mm -> g 线性模型)
  rpc SetPumpCalibration(PumpCalibrationRequest) returns (google.protobuf.Empty);
  
  // 获取业务配置
  rpc GetLoadCellConfig(google.protobuf.Empty) returns (LoadCellConfig);
  
  // 保存业务配置
  rpc SaveLoadCellConfig(LoadCellConfig) returns (google.protobuf.Empty);
  
  // === 运行时操作 ===
  // 去皮 (将当前重量设为零)
  rpc Tare(google.protobuf.Empty) returns (LoadCellReading);
  
  // 获取当前读数
  rpc GetReading(google.protobuf.Empty) returns (LoadCellReading);
  
  // 订阅实时读数流
  rpc StreamReadings(google.protobuf.Empty) returns (stream LoadCellReading);
}

// ============================================================
// 称重服务消息定义
// ============================================================

// 称重读数
message LoadCellReading {
  float weight_grams = 1;         // 标定后的克数
  float raw_percent = 2;          // 原始百分比 (-100% ~ 100%)
  bool is_calibrated = 3;         // 是否已完成硬件标定
  bool is_stable = 4;             // 是否稳定
  WeightTrend trend = 5;          // 重量趋势
  google.protobuf.Timestamp timestamp = 6;
  
  enum WeightTrend {
    WEIGHT_TREND_UNSPECIFIED = 0;
    STABLE = 1;
    INCREASING = 2;
    DECREASING = 3;
  }
}

// 标定状态
message CalibrationStatus {
  CalibrationStep step = 1;       // 当前步骤
  float current_reading = 2;      // 当前读数 (原始百分比或克数)
  string message = 3;             // 提示信息
  bool success = 4;               // 操作是否成功
  
  enum CalibrationStep {
    CALIBRATION_STEP_UNSPECIFIED = 0;
    IDLE = 1;                     // 未在标定
    ZERO_POINT = 2;               // 等待设置零点
    REFERENCE_WEIGHT = 3;         // 等待设置参考重量
    VERIFY = 4;                   // 验证阶段
    COMPLETE = 5;                 // 标定完成
  }
}

// 参考重量请求
message ReferenceWeightRequest {
  float weight_grams = 1;         // 用户输入的参考物体重量 (克)
}

// 标定结果
message CalibrationResult {
  bool success = 1;
  string message = 2;
  float reference_tare_counts = 3;  // 零点计数
  float counts_per_gram = 4;        // 每克计数
  float total_capacity_kg = 5;      // 总量程 (kg)
}

// 阈值请求
message ThresholdRequest {
  float value = 1;                // 阈值 (克)
}

// 等待空瓶请求
message WaitForEmptyBottleRequest {
  float tolerance = 1;              // 容差 (g)，默认 30
  float timeout_sec = 2;            // 超时时间 (s)，默认 60
  float stability_window_sec = 3;   // 稳定窗口 (s)，默认 5
}

// 等待空瓶响应
message WaitForEmptyBottleResponse {
  bool success = 1;                 // 是否成功
  float empty_weight = 2;           // 稳定后的空瓶重量 (g)
  string error_message = 3;         // 错误信息（如超时）
}

// 动态空瓶值响应
message DynamicEmptyWeightResponse {
  bool has_value = 1;               // 是否有动态空瓶值
  float empty_weight = 2;           // 动态空瓶值 (g)
}

// 称重业务配置
message LoadCellConfig {
  float overflow_threshold = 1;     // 溢出警告阈值 (g)
  float drain_complete_margin = 2;  // 排空完成余量 (g)
  float stable_threshold = 3;       // 稳定判断阈值 (g)
  string last_calibration_time = 4; // 最后标定时间
  
  // 泵校准系数 (mm -> 测量重量 g)
  // 线性模型: measured_weight = mm * pump_mm_to_ml + pump_mm_offset
  float pump_mm_to_ml = 5;          // g/mm (斜率)
  float pump_mm_offset = 6;         // g (截距)
  
  // 重量校准系数 (测量值 -> 真实值)
  // 线性模型: real_weight = weight_scale * measured_weight + weight_offset
  float weight_scale = 7;           // 斜率
  float weight_offset = 8;          // 截距 (g)
}

// 泵校准系数请求
message PumpCalibrationRequest {
  float slope = 1;                  // 斜率 (g/mm)
  float offset = 2;                 // 截距 (g)
}

// ============================================================
// 自动测试服务 (TestService)
// 测试逻辑在后端运行，前端仅轮询状态
// ============================================================
service TestService {
  // 启动自动测试
  rpc StartTest(StartTestRequest) returns (TestStatusResponse);
  
  // 停止测试
  rpc StopTest(google.protobuf.Empty) returns (TestStatusResponse);
  
  // 获取测试状态 (用于轮询)
  rpc GetTestStatus(google.protobuf.Empty) returns (TestStatusResponse);
  
  // 获取测试结果 (当前运行的内存结果)
  rpc GetTestResults(google.protobuf.Empty) returns (TestResultsResponse);
  
  // 清除测试结果
  rpc ClearTestResults(google.protobuf.Empty) returns (google.protobuf.Empty);
  
  // === 历史数据查询 (从数据库) ===
  
  // 获取历史测试运行列表
  rpc ListTestRuns(ListTestRunsRequest) returns (ListTestRunsResponse);
  
  // 获取单个测试运行详情
  rpc GetTestRun(GetTestRunRequest) returns (TestRunDetail);
  
  // 获取测试运行的结果列表
  rpc GetTestRunResults(GetTestRunRequest) returns (TestResultsResponse);
  
  // 获取称重过程数据 (用于绘制曲线)
  rpc GetWeightSamples(GetWeightSamplesRequest) returns (WeightSamplesResponse);
}

// ============================================================
// 测试服务消息定义
// ============================================================

// 单组参数配置
message ParamSet {
  int32 id = 1;
  string name = 2;
  float pump2_volume = 3;           // 泵2进样量 (mm)
  float pump3_volume = 4;           // 泵3进样量 (mm)
  float pump4_volume = 5;           // 泵4进样量 (mm)
  float pump5_volume = 6;           // 泵5进样量 (mm)
  float speed = 7;                  // 进样速度 (mm/s)
  int32 cycles = 8;                 // 循环次数
}

// 启动测试请求
message StartTestRequest {
  repeated ParamSet param_sets = 1; // 参数组列表
  float accel = 2;                  // 加速度 (mm/s²)
  float empty_tolerance = 3;        // 空瓶容差 (g)
  float drain_stability_window = 4; // 排废稳定窗口 (s)
}

// 测试状态枚举
enum TestState {
  TEST_STATE_UNSPECIFIED = 0;
  TEST_IDLE = 1;                    // 空闲
  TEST_DRAINING = 2;                // 排废中
  TEST_WAITING_EMPTY = 3;           // 等待空瓶稳定
  TEST_INJECTING = 4;               // 进样中
  TEST_WAITING_STABLE = 5;          // 等待称重稳定
  TEST_COMPLETE = 6;                // 测试完成
  TEST_ERROR = 7;                   // 错误状态
  TEST_STOPPING = 8;                // 正在停止
}

// 测试状态响应
message TestStatusResponse {
  TestState state = 1;              // 当前状态
  int32 current_param_set = 2;      // 当前参数组索引 (1-based)
  int32 total_param_sets = 3;       // 总参数组数
  int32 current_cycle = 4;          // 当前循环 (1-based)
  int32 total_cycles = 5;           // 当前参数组总循环数
  int32 global_cycle = 6;           // 全局循环计数
  int32 global_total_cycles = 7;    // 全局总循环数
  string current_param_name = 8;    // 当前参数组名称
  string message = 9;               // 状态消息/日志
  repeated string logs = 10;        // 最近日志列表
  float dynamic_empty_weight = 11;  // 当前动态空瓶值
  bool has_dynamic_empty_weight = 12; // 是否有动态空瓶值
  int32 run_id = 13;                // 数据库 run_id (0 表示无持久化)
}

// 单次测试结果
message TestResult {
  int32 param_set_id = 1;
  string param_set_name = 2;
  int32 cycle = 3;
  float total_volume = 4;           // 设定总量 (mm)
  float pump2_volume = 5;
  float pump3_volume = 6;
  float pump4_volume = 7;
  float pump5_volume = 8;
  float speed = 9;
  float empty_weight = 10;          // 空瓶重量 (g)
  float full_weight = 11;           // 进样后重量 (g)
  float injected_weight = 12;       // 实际进样重量 (g)
  int64 drain_duration_ms = 13;     // 排废耗时 (ms)
  int64 wait_empty_duration_ms = 14;// 等待空瓶耗时 (ms)
  int64 inject_duration_ms = 15;    // 进样耗时 (ms)
  int64 wait_stable_duration_ms = 16;// 等待稳定耗时 (ms)
  int64 total_duration_ms = 17;     // 总耗时 (ms)
  google.protobuf.Timestamp timestamp = 18;
}

// 测试结果响应
message TestResultsResponse {
  repeated TestResult results = 1;
  int32 total_count = 2;
}

// ============================================================
// 历史数据查询消息定义
// ============================================================

// 列出测试运行请求
message ListTestRunsRequest {
  int32 limit = 1;                    // 最大返回数量 (默认50)
  int32 offset = 2;                   // 偏移量 (分页)
  string state_filter = 3;            // 状态过滤 (running/completed/error/aborted)
}

// 列出测试运行响应
message ListTestRunsResponse {
  repeated TestRunSummary runs = 1;
  int32 total_count = 2;
}

// 测试运行摘要
message TestRunSummary {
  int32 run_id = 1;
  google.protobuf.Timestamp created_at = 2;
  google.protobuf.Timestamp completed_at = 3;
  string state = 4;                   // running/completed/error/aborted
  int32 current_step = 5;
  int32 total_steps = 6;
  string error_message = 7;
}

// 获取测试运行请求
message GetTestRunRequest {
  int32 run_id = 1;
}

// 测试运行详情
message TestRunDetail {
  int32 run_id = 1;
  google.protobuf.Timestamp created_at = 2;
  google.protobuf.Timestamp completed_at = 3;
  string state = 4;
  string config_json = 5;             // 测试配置 JSON
  int32 current_step = 6;
  int32 total_steps = 7;
  string error_message = 8;
  repeated TestResult results = 9;    // 测试结果列表
}

// 获取称重样本请求
message GetWeightSamplesRequest {
  int32 run_id = 1;                   // 测试运行 ID
  optional int32 cycle = 2;           // 可选: 指定循环号
  optional google.protobuf.Timestamp start_time = 3;  // 可选: 开始时间
  optional google.protobuf.Timestamp end_time = 4;    // 可选: 结束时间
  int32 limit = 5;                    // 最大返回数量 (默认10000)
}

// 称重样本响应
message WeightSamplesResponse {
  repeated WeightSample samples = 1;
  int32 total_count = 2;
}

// 单个称重样本
message WeightSample {
  google.protobuf.Timestamp time = 1;
  int32 run_id = 2;
  int32 cycle = 3;
  string phase = 4;                   // drain/wait_empty/inject/wait_stable
  float weight = 5;                   // 重量 (g)
  bool is_stable = 6;
  string trend = 7;                   // stable/increasing/decreasing
}
