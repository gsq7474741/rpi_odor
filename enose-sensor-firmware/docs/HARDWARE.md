# 硬件连接指南

> enose-sensor-firmware 支持的硬件配置和连接方式

## 1. 支持的硬件配置

### 1.1 BME688 Development Kit (默认)

Bosch BME688 开发套件，8 通道数字 MOX 气体传感器。

**组件清单**:

| 组件 | 型号 | 数量 | 说明 |
|------|------|------|------|
| 主控板 | Adafruit Feather ESP32 | 1 | 带 USB 接口 |
| 传感器板 | BME688 Dev Kit Board | 1 | 8x BME688 |
| I2C 扩展器 | TCA9548A | 1 | 集成在板上 |
| 连接线 | FPC/排线 | 1 | 连接主控和传感器板 |

**连接方式**:

```
ESP32 Feather                BME688 Dev Kit Board
┌────────────┐               ┌─────────────────────┐
│            │               │  TCA9548A (I2C Mux) │
│        SDA ├───────────────┤ SDA                 │
│        SCL ├───────────────┤ SCL                 │
│            │               │    │                │
│        SCK ├───────────────┤ SCLK   ┌──────────┐ │
│       MOSI ├───────────────┤ MOSI   │ BME688x8 │ │
│       MISO ├───────────────┤ MISO   │ (SPI)    │ │
│            │               │ CS0-7  └──────────┘ │
│            │               │                     │
│        3V3 ├───────────────┤ VCC                 │
│        GND ├───────────────┤ GND                 │
└────────────┘               └─────────────────────┘
```

**通信原理**:
1. ESP32 通过 I2C 控制 TCA9548A 选择目标传感器
2. 选中后通过 SPI 与 BME688 通信
3. 每个 BME688 有独立的 CS 片选

### 1.2 模拟 MOX 传感器阵列 (可选)

适用于 GM102B 等模拟输出的 MOX 传感器，通过 SPI ADC 读取。

**支持的 ADC 芯片**:

| ADC 芯片 | 分辨率 | 通道数 | 采样率 |
|----------|--------|--------|--------|
| ADS1256 | 24-bit | 8 | 30kSPS |
| MCP3208 | 12-bit | 8 | 100kSPS |

**连接方式 (ADS1256)**:

```
ESP32 Feather              ADS1256              GM102B Sensors
┌────────────┐           ┌────────┐           ┌────────────────┐
│            │           │        │           │ Sensor 0       │
│        SCK ├───────────┤ SCLK   │           │   Vout ────────┼─┐
│       MOSI ├───────────┤ DIN    │           │   Vcc ─────────┼─┼─ 5V
│       MISO ├───────────┤ DOUT   │           │   GND ─────────┼─┼─ GND
│         D5 ├───────────┤ CS     │           └────────────────┘ │
│            │           │        │                              │
│            │           │ AIN0 ──┼──────────────────────────────┘
│            │           │ AIN1-7 │ ─── (其他传感器)
│            │           │        │
│        3V3 ├───────────┤ AVDD   │
│        GND ├───────────┤ AGND   │
└────────────┘           └────────┘
```

---

## 2. ESP32 引脚定义

### 2.1 固定引脚

| 引脚 | 功能 | 说明 |
|------|------|------|
| GPIO 13 | LED | 状态指示灯 |
| GPIO 22 | SCL | I2C 时钟 (BME688) |
| GPIO 23 | SDA | I2C 数据 (BME688) |
| GPIO 18 | SCK | SPI 时钟 |
| GPIO 23 | MOSI | SPI 主出从入 |
| GPIO 19 | MISO | SPI 主入从出 |

### 2.2 可配置引脚

| 引脚 | 功能 | 配置项 |
|------|------|--------|
| GPIO 5 | ADC CS | `ADC_CS_PIN` (模拟传感器) |
| GPIO 16 | Serial2 RX | `SERIAL2_RX_PIN` (双串口模式) |
| GPIO 17 | Serial2 TX | `SERIAL2_TX_PIN` (双串口模式) |

---

## 3. 电源要求

### 3.1 供电规格

| 参数 | 值 | 说明 |
|------|-----|------|
| 输入电压 | 5V (USB) | 通过 USB 供电 |
| 工作电流 | ~200mA | 8 个传感器全开 |
| 峰值电流 | ~400mA | 加热器同时工作 |

### 3.2 注意事项

- USB 供电通常足够，但建议使用质量好的 USB 线
- 如使用电池供电，确保电池容量足够
- 避免与大功率设备共用电源

---

## 4. 传感器特性

### 4.1 BME688

| 参数 | 范围 | 精度 |
|------|------|------|
| 温度 | -40°C ~ +85°C | ±0.5°C |
| 湿度 | 0% ~ 100% RH | ±3% RH |
| 气压 | 300 ~ 1100 hPa | ±0.6 hPa |
| 气体电阻 | 10Ω ~ 10MΩ | - |

**加热器配置**:
- 10 步加热器曲线
- 温度范围: 200°C ~ 400°C
- 持续时间: 可配置

**默认加热器配置**:

```
步骤: 0    1    2    3    4    5    6    7    8    9
温度: 320  100  100  100  200  200  200  320  320  320 (°C)
时长: 5    2    10   30   5    5    5    5    5    5   (因子)
```

### 4.2 模拟 MOX (GM102B 等)

| 参数 | 范围 | 说明 |
|------|------|------|
| 工作电压 | 5V ± 0.1V | 需要稳定电源 |
| 加热电压 | 5V | 持续加热 |
| 输出电压 | 0 ~ 3.3V | 通过 ADC 读取 |
| 预热时间 | >24h | 首次使用 |

---

## 5. 组装指南

### 5.1 BME688 Development Kit

1. **连接传感器板**: 将 BME688 Dev Kit Board 通过 FPC 排线连接到 ESP32 Feather
2. **检查连接**: 确认 I2C 和 SPI 引脚正确连接
3. **供电**: 通过 USB 连接电脑
4. **烧录固件**: 使用 PlatformIO 烧录

### 5.2 模拟传感器阵列

1. **焊接 ADC 模块**: 将 ADS1256/MCP3208 焊接或连接到面包板
2. **连接传感器**: 将 GM102B 等传感器的模拟输出连接到 ADC 输入通道
3. **连接 ESP32**: 按照引脚定义连接 SPI 信号
4. **修改配置**: 在 `config.h` 中设置 `SENSOR_TYPE_ANALOG`
5. **烧录固件**: 使用 PlatformIO 烧录

---

## 6. 故障排查

### 6.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 无法初始化 | I2C/SPI 连接问题 | 检查排线和焊接 |
| 读数为 0 | 传感器未供电 | 检查电源连接 |
| 读数不稳定 | 电源噪声 | 添加去耦电容 |
| 个别通道失效 | 传感器损坏 | 更换传感器 |

### 6.2 调试方法

1. **检查就绪消息**: 启动后应看到 `{"type": "ready", ...}`
2. **使用 status 命令**: 查看各传感器状态
3. **LED 指示**: 快闪表示错误，慢闪表示正常
4. **串口日志**: 监控错误消息

---

## 7. 扩展硬件

### 7.1 添加更多传感器

当前设计支持最多 8 通道。如需更多:
1. 使用多个 ESP32 模块
2. 每个模块连接独立传感器阵列
3. 上位机同时连接多个串口

### 7.2 添加其他类型传感器

固件架构支持扩展:
1. 在 `sensors/` 目录实现新的 `ISensorArray` 子类
2. 在 `config.h` 添加配置选项
3. 在 `main.cpp` 添加条件编译

**计划支持**:
- PID 传感器 (保留类型 `SensorType::PID`)
- EC 传感器
- IR 传感器

---

## 8. 参考资料

- [BME688 数据手册](https://www.bosch-sensortec.com/products/environmental-sensors/gas-sensors/bme688/)
- [Adafruit Feather ESP32 引脚图](https://learn.adafruit.com/adafruit-huzzah32-esp32-feather/pinouts)
- [ADS1256 数据手册](https://www.ti.com/product/ADS1256)
- [MCP3208 数据手册](https://www.microchip.com/en-us/product/MCP3208)
