[mcu]
# 替换为实际的串口 ID
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_190044000651343437343531-if00

[include mainsail.cfg]

# E-Nose 控制插件 (急停、泵控制等扩展功能)
[enose_control]
pump_names: pump_2, pump_3, pump_4, pump_5

[printer]
kinematics: none
max_velocity: 100
max_accel: 100

# ======================================================================
# 蠕动泵控制宏 (Pump Control Macros)
# ======================================================================

[gcode_macro PUMP_CONTROL]
description: 控制蠕动泵转动
gcode:
    {% set pump_name = params.NAME|default("pump_0") %}
    {% set speed = params.SPEED|default(50)|float %}
    {% set distance = params.DISTANCE|default(100)|float %}
    {% set accel = params.ACCEL|default(100)|float %}
    
    # 先重置位置为0，实现相对位置模式（蠕动泵无限位）
    MANUAL_STEPPER STEPPER={pump_name} SET_POSITION=0
    # 使用 SYNC=0 异步执行，防止阻塞
    MANUAL_STEPPER STEPPER={pump_name} SPEED={speed} ACCEL={accel} MOVE={distance} SYNC=0

[gcode_macro STOP_PUMP]
description: 停止指定蠕动泵
gcode:
    {% set pump_name = params.NAME|default("pump_0") %}
    MANUAL_STEPPER STEPPER={pump_name} ENABLE=0

# 快捷控制按钮 (可选)
[gcode_macro SAMPLE_PUMP_0_ON]
gcode:
    MANUAL_STEPPER STEPPER=pump_2 SET_POSITION=0
    MANUAL_STEPPER STEPPER=pump_2 SPEED=50 MOVE=100 SYNC=0

[gcode_macro SAMPLE_PUMP_1_ON]
gcode:
    MANUAL_STEPPER STEPPER=pump_3 SET_POSITION=0
    MANUAL_STEPPER STEPPER=pump_3 SPEED=50 MOVE=100 SYNC=0

[gcode_macro SAMPLE_PUMP_2_ON]
gcode:
    MANUAL_STEPPER STEPPER=pump_4 SET_POSITION=0
    MANUAL_STEPPER STEPPER=pump_4 SPEED=50 MOVE=100 SYNC=0

[gcode_macro SAMPLE_PUMP_3_ON]
gcode:
    MANUAL_STEPPER STEPPER=pump_5 SET_POSITION=0
    MANUAL_STEPPER STEPPER=pump_5 SPEED=50 MOVE=100 SYNC=0

[gcode_macro STOP_ALL_PUMPS]
gcode:
    MANUAL_STEPPER STEPPER=pump_2 ENABLE=0
    MANUAL_STEPPER STEPPER=pump_3 ENABLE=0
    MANUAL_STEPPER STEPPER=pump_4 ENABLE=0
    MANUAL_STEPPER STEPPER=pump_5 ENABLE=0

# 注册泵到 G1 坐标轴，实现并行控制
# 调用后可使用 G1 A100 B200 C300 D400 F3000 同时控制所有泵
[gcode_macro REGISTER_PUMPS_TO_AXIS]
description: 将泵注册到 GCODE_AXIS，支持 G1 并行控制
gcode:
    # 先归零所有泵位置
    MANUAL_STEPPER STEPPER=pump_2 SET_POSITION=0
    MANUAL_STEPPER STEPPER=pump_3 SET_POSITION=0
    MANUAL_STEPPER STEPPER=pump_4 SET_POSITION=0
    MANUAL_STEPPER STEPPER=pump_5 SET_POSITION=0
    # 注册到 A/B/C/D 轴
    MANUAL_STEPPER STEPPER=pump_2 GCODE_AXIS=A LIMIT_VELOCITY=50 LIMIT_ACCEL=100
    MANUAL_STEPPER STEPPER=pump_3 GCODE_AXIS=B LIMIT_VELOCITY=50 LIMIT_ACCEL=100
    MANUAL_STEPPER STEPPER=pump_4 GCODE_AXIS=C LIMIT_VELOCITY=50 LIMIT_ACCEL=100
    MANUAL_STEPPER STEPPER=pump_5 GCODE_AXIS=D LIMIT_VELOCITY=50 LIMIT_ACCEL=100
    M118 Pumps registered to GCODE_AXIS: A=pump_2, B=pump_3, C=pump_4, D=pump_5

# 取消注册，恢复 MANUAL_STEPPER 控制
[gcode_macro UNREGISTER_PUMPS]
description: 取消泵的 GCODE_AXIS 注册
gcode:
    MANUAL_STEPPER STEPPER=pump_2 GCODE_AXIS=
    MANUAL_STEPPER STEPPER=pump_3 GCODE_AXIS=
    MANUAL_STEPPER STEPPER=pump_4 GCODE_AXIS=
    MANUAL_STEPPER STEPPER=pump_5 GCODE_AXIS=
    M118 Pumps unregistered from GCODE_AXIS

# 急停并行运动 (M112 + 自动重启)
# 这是唯一能真正中断 MCU 步进队列的方法
[gcode_macro EMERGENCY_STOP_PUMPS]
description: 急停所有泵运动 (会自动重启固件)
gcode:
    M112

# 软停止 - 仅取消注册 (不能中断已排队的步进)
[gcode_macro SOFT_STOP_PUMPS]
description: 软停止 (不能中断正在执行的运动)
gcode:
    MANUAL_STEPPER STEPPER=pump_2 GCODE_AXIS=
    MANUAL_STEPPER STEPPER=pump_3 GCODE_AXIS=
    MANUAL_STEPPER STEPPER=pump_4 GCODE_AXIS=
    MANUAL_STEPPER STEPPER=pump_5 GCODE_AXIS=
    MANUAL_STEPPER STEPPER=pump_2 ENABLE=0
    MANUAL_STEPPER STEPPER=pump_3 ENABLE=0
    MANUAL_STEPPER STEPPER=pump_4 ENABLE=0
    MANUAL_STEPPER STEPPER=pump_5 ENABLE=0
    M118 Soft stop (motion may continue until queue empties)

# 并行进样宏 - 单条命令同时驱动所有泵
[gcode_macro INJECT_PARALLEL]
description: 并行进样 (参数: A B C D 为各泵行程mm, F为速度mm/min)
gcode:
    {% set a = params.A|default(0)|float %}
    {% set b = params.B|default(0)|float %}
    {% set c = params.C|default(0)|float %}
    {% set d = params.D|default(0)|float %}
    {% set f = params.F|default(3000)|float %}
    # 确保已注册
    REGISTER_PUMPS_TO_AXIS
    # 使用 G1 并行移动
    G1 A{a} B{b} C{c} D{d} F{f}

# ======================================================================
# 蠕动泵阵列 (Peristaltic Pumps)
# 使用 manual_stepper 以便独立控制
# ======================================================================

# 泵 0: (未安装)
#[manual_stepper pump_0]
#step_pin: PF13
#dir_pin: PF12
#enable_pin: !PF14
#microsteps: 16
#rotation_distance: 40
#velocity: 50
#accel: 100

#[tmc2209 manual_stepper pump_0]
#uart_pin: PC4
#run_current: 0.800
#stealthchop_threshold: 999999

# 泵 1: (未安装)
#[manual_stepper pump_1]
#step_pin: PG0
#dir_pin: PG1
#enable_pin: !PF15
#microsteps: 16
#rotation_distance: 40
#velocity: 50
#accel: 100

#[tmc2209 manual_stepper pump_1]
#uart_pin: PD11
#run_current: 0.800
#stealthchop_threshold: 999999

# 泵 2: 清洗泵 (Cleaning Pump)
[manual_stepper pump_2]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
microsteps: 16
rotation_distance: 40  # 需校准：转一圈泵出的液体长度/体积换算
velocity: 50
accel: 100

[tmc2209 manual_stepper pump_2]
uart_pin: PC6
run_current: 0.800
stealthchop_threshold: 999999

# 泵 3: 样品泵 1 (Sample 1)
[manual_stepper pump_3]
step_pin: PG4
dir_pin: PC1
enable_pin: !PA0
microsteps: 16
rotation_distance: 40
velocity: 50
accel: 100

[tmc2209 manual_stepper pump_3]
uart_pin: PC7
run_current: 0.800
stealthchop_threshold: 999999

# 泵 4: 样品泵 2 (Sample 2)
[manual_stepper pump_4]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
microsteps: 16
rotation_distance: 40
velocity: 50
accel: 100

[tmc2209 manual_stepper pump_4]
uart_pin: PF2
run_current: 0.800
stealthchop_threshold: 999999

# 泵 5: 样品泵 3 (Sample 3)
[manual_stepper pump_5]
step_pin: PC13
dir_pin: PF0
enable_pin: !PF1
microsteps: 16
rotation_distance: 40
velocity: 50
accel: 100

[tmc2209 manual_stepper pump_5]
uart_pin: PE4
run_current: 0.800
stealthchop_threshold: 999999

# 泵 6: 样品泵 6 (未安装)
#[manual_stepper pump_6]
#step_pin: PE2
#dir_pin: PE3
#enable_pin: !PD4
#microsteps: 16
#rotation_distance: 40
#velocity: 50
#accel: 100

#[tmc2209 manual_stepper pump_6]
#uart_pin: PE1
#run_current: 0.800
#stealthchop_threshold: 999999

# 泵 7: 样品泵 7 (未安装)
#[manual_stepper pump_7]
#step_pin: PE6
#dir_pin: PA14
#enable_pin: !PE0
#microsteps: 16
#rotation_distance: 40
#velocity: 50
#accel: 100

#[tmc2209 manual_stepper pump_7]
#uart_pin: PD3
#run_current: 0.800
#stealthchop_threshold: 999999

# ======================================================================
# 执行器 (Actuators)
# ======================================================================

# 气泵 (Air Pump) - 三线制 PWM 控制
# VCC/GND 接电源，信号线接 BLTouch Servo (PB6)
[output_pin air_pump_pwm]
pin: !PB6
pwm: True
# 频率取决于泵的规格。这里预设为 1kHz (0.001s)
# 如果泵需要舵机信号 (50Hz), 改为 0.020
cycle_time: 0.001
value: 0
shutdown_value: 0


# 阀门：废液阀 (Switch Logic) - 接 HE0 (PA2)
# 0: 关闭, 1: 开启
[output_pin valve_waste]
pin: PA2
pwm: False
value: 0
shutdown_value: 0

# 阀门：夹管三通阀 (Switch Logic) - 接 HE1 (PA3)
# 0: 液路, 1: 气路
[output_pin valve_pinch]
pin: PA3
pwm: False
value: 0
shutdown_value: 0

# 阀门：三通气阀 (Switch Logic) - 接 HE2 (PB10)
# 0: 排气, 1: 气室
[output_pin valve_air]
pin: PB10
pwm: False
value: 0
shutdown_value: 0

# 阀门：出气阀 (Switch Logic) - 接 HE3 (PB11)
# 0: 开启, 1: 关闭 (反向逻辑)
[output_pin valve_outlet]
pin: !PB11
pwm: False
value: 0
shutdown_value: 0

# ----------------------------------------------------------------------
# 阀门控制宏 (Valve Control Macros)
# ----------------------------------------------------------------------

# 废液阀控制
[gcode_macro VALVE_WASTE_OPEN]
description: 打开废液阀
gcode:
    SET_PIN PIN=valve_waste VALUE=1

[gcode_macro VALVE_WASTE_CLOSE]
description: 关闭废液阀
gcode:
    SET_PIN PIN=valve_waste VALUE=0

# 夹管三通阀控制
[gcode_macro VALVE_PINCH_LIQUID]
description: 夹管阀切换到液路
gcode:
    SET_PIN PIN=valve_pinch VALUE=1

[gcode_macro VALVE_PINCH_GAS]
description: 夹管阀切换到气路
gcode:
    SET_PIN PIN=valve_pinch VALUE=0

# 三通气阀控制
[gcode_macro VALVE_AIR_CHAMBER]
description: 三通气阀连接气室
gcode:
    SET_PIN PIN=valve_air VALUE=1

[gcode_macro VALVE_AIR_VENT]
description: 三通气阀排气到大气
gcode:
    SET_PIN PIN=valve_air VALUE=0

# 出气阀控制 (反向逻辑: VALUE=1 关闭, VALUE=0 打开)
[gcode_macro VALVE_OUTLET_OPEN]
description: 打开出气阀
gcode:
    SET_PIN PIN=valve_outlet VALUE=0

[gcode_macro VALVE_OUTLET_CLOSE]
description: 关闭出气阀
gcode:
    SET_PIN PIN=valve_outlet VALUE=1

# 一键关闭所有阀门
[gcode_macro CLOSE_ALL_VALVES]
description: 关闭所有阀门
gcode:
    SET_PIN PIN=valve_waste VALUE=0
    SET_PIN PIN=valve_pinch VALUE=0
    SET_PIN PIN=valve_air VALUE=0
    SET_PIN PIN=valve_outlet VALUE=1

# ======================================================================
# 扩展设备 (Expansion Devices)
# ======================================================================

# 清洗泵 (Cleaning Pump) - 接 FAN0 (PA8)
# 24V DC 泵，使用板载 FAN 接口 MOS 管直接驱动
# 注意: 确保 V_FAN 跳线设为 24V
[output_pin cleaning_pump]
pin: PA8
pwm: True
cycle_time: 0.010
value: 0
shutdown_value: 0

[gcode_macro CLEANING_PUMP_ON]
description: 开启清洗泵
gcode:
    SET_PIN PIN=cleaning_pump VALUE=1.0

[gcode_macro CLEANING_PUMP_OFF]
description: 关闭清洗泵
gcode:
    SET_PIN PIN=cleaning_pump VALUE=0

# ======================================================================
# 传感器与加热 (Sensors & Heaters)
# ======================================================================

# 气室加热带 - 接 BED_OUT (PA1) + T0 (PF4)
#[heater_generic heater_chamber]
#heater_pin: PA1
#sensor_type: EPCOS 100K B57560G104F
#sensor_pin: PF4
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
#min_temp: 0
#max_temp: 100

# 称重传感器 (HX711) - 接 STOP_0 (PG6) 和 STOP_1 (PG9)
# 需要 Klipper 主线版本支持 [load_cell]
[load_cell scale]
sensor_type: hx711
sclk_pin: PG9
dout_pin: PG6
# 标定步骤:
# 1. 只有空盘时运行: QUERY_LOAD_CELL SENSOR=scale
# 2. 放已知重量 (如 100g) 运行 QUERY_LOAD_CELL
# 3. 使用 LOAD_CELL_CALIBRATE 进行标定

